generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      UserRole @default(ANALYST)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  submittedReports Report[] @relation("SubmittedBy")
  reviewedReports  Report[] @relation("ReviewedBy")

  @@map("users")
}

enum UserRole {
  ANALYST
  ACCOUNT_MANAGER
  MANAGER
  ADMIN
}

// ============================================
// Client Management
// ============================================

model Client {
  id       String       @id @default(uuid())
  name     String
  industry String?
  status   ClientStatus @default(ACTIVE)

  // Platform configurations
  metaAdsAccountIds String[] @map("meta_ads_account_ids")
  ga4PropertyIds    String[] @map("ga4_property_ids")
  equals5Enabled    Boolean  @default(false) @map("equals5_enabled")

  // Google Drive folders
  screenshotFolderId String? @map("screenshot_folder_id")
  deliveryFolderId   String? @map("delivery_folder_id")

  // Branding
  logoUrl        String? @map("logo_url")
  primaryColor   String? @map("primary_color")
  secondaryColor String? @map("secondary_color")

  // Template
  slidesTemplateId String? @map("slides_template_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  credential  Credential?
  metaAdsData MetaAdsData[]
  gaData      GAData[]
  equals5Data Equals5Data[]
  reports     Report[]

  @@map("clients")
}

enum ClientStatus {
  ACTIVE
  INACTIVE
}

// ============================================
// Credentials (Encrypted)
// ============================================

model Credential {
  id            String   @id @default(uuid())
  clientId      String   @unique @map("client_id")
  platform      String   @default("equals5")
  encryptedData String   @map("encrypted_data") // JSON encrypted
  lastUsed      DateTime? @map("last_used")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("credentials")
}

// ============================================
// Marketing Data
// ============================================

model MetaAdsData {
  id        String   @id @default(uuid())
  clientId  String   @map("client_id")
  accountId String   @map("account_id")
  dateStart DateTime @map("date_start")
  dateEnd   DateTime @map("date_end")

  // Metrics
  spend       Decimal @db.Decimal(12, 2)
  impressions BigInt
  reach       BigInt
  clicks      BigInt
  ctr         Decimal @db.Decimal(5, 4)

  // Campaign breakdown
  campaigns Json?

  fetchedAt DateTime @default(now()) @map("fetched_at")

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, dateStart, dateEnd])
  @@map("meta_ads_data")
}

model GAData {
  id         String   @id @default(uuid())
  clientId   String   @map("client_id")
  propertyId String   @map("property_id")
  dateStart  DateTime @map("date_start")
  dateEnd    DateTime @map("date_end")

  // Metrics
  sessions       BigInt
  users          BigInt
  newUsers       BigInt  @map("new_users")
  conversions    BigInt
  trafficSources Json?   @map("traffic_sources")

  fetchedAt DateTime @default(now()) @map("fetched_at")

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, dateStart, dateEnd])
  @@map("ga_data")
}

model Equals5Data {
  id        String   @id @default(uuid())
  clientId  String   @map("client_id")
  dateStart DateTime @map("date_start")
  dateEnd   DateTime @map("date_end")

  // Raw data from extraction
  rawData Json? @map("raw_data")

  // Extracted metrics (for quick access)
  spend       Decimal? @db.Decimal(12, 2)
  impressions BigInt?
  clicks      BigInt?

  // Extraction status
  extractionStatus   ExtractionStatus @default(PENDING) @map("extraction_status")
  errorMessage       String?          @map("error_message")
  debugScreenshotPath String?         @map("debug_screenshot_path")

  fetchedAt DateTime @default(now()) @map("fetched_at")

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, dateStart, dateEnd])
  @@map("equals5_data")
}

enum ExtractionStatus {
  PENDING
  SUCCESS
  FAILED
}

// ============================================
// Reports
// ============================================

model Report {
  id       String       @id @default(uuid())
  clientId String       @map("client_id")
  period   String       // YYYY-MM format
  status   ReportStatus @default(DRAFT)

  // Report outputs
  slidesUrl        String? @map("slides_url")
  xlsxUrl          String? @map("xlsx_url")
  executiveSummary String? @map("executive_summary")

  // Workflow
  submittedById String?   @map("submitted_by_id")
  submittedAt   DateTime? @map("submitted_at")
  reviewedById  String?   @map("reviewed_by_id")
  reviewedAt    DateTime? @map("reviewed_at")
  rejectionReason String? @map("rejection_reason")
  deliveredAt   DateTime? @map("delivered_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  client      Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  submittedBy User?   @relation("SubmittedBy", fields: [submittedById], references: [id])
  reviewedBy  User?   @relation("ReviewedBy", fields: [reviewedById], references: [id])
  statusHistory ReportStatusHistory[]

  @@unique([clientId, period])
  @@index([clientId])
  @@index([status])
  @@map("reports")
}

enum ReportStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  DELIVERED
}

model ReportStatusHistory {
  id        String   @id @default(uuid())
  reportId  String   @map("report_id")
  oldStatus ReportStatus? @map("old_status")
  newStatus ReportStatus  @map("new_status")
  changedBy String?  @map("changed_by")
  comment   String?
  changedAt DateTime @default(now()) @map("changed_at")

  // Relations
  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@map("report_status_history")
}

// ============================================
// Templates
// ============================================

model Template {
  id               String   @id @default(uuid())
  name             String
  slidesDocumentId String   @map("slides_document_id")
  placeholders     Json?    // Placeholder mappings
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("templates")
}
